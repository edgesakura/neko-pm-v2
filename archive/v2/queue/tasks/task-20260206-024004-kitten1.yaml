task_id: "task-20260206-024004-kitten1"
assigned_to: "kitten1"
timestamp: "2026-02-06T02:40:04"
priority: medium
load_skills: []
description: |
  ## ğŸ¯ ã‚¹ã‚­ãƒ«åŒ–ä½œæˆ¦: 4ä»¶ã®ã‚¹ã‚­ãƒ«ã‚’ä½œæˆã™ã‚‹ã«ã‚ƒ

  AgentCoreãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆã§åŸ¹ã£ãŸçŸ¥è¦‹ã‚’å†åˆ©ç”¨å¯èƒ½ãªã‚¹ã‚­ãƒ«ã¨ã—ã¦ä¿å­˜ã™ã‚‹ã«ã‚ƒã€‚

  ## ä½œæˆã™ã‚‹ã‚¹ã‚­ãƒ«

  ### 1. bedrock-agentcore-api-migration-guideï¼ˆ17/20ï¼‰

  **ä¿å­˜å…ˆ**: ~/.claude/skills/bedrock-agentcore-api-migration-guide/SKILL.md

  **å†…å®¹**:
  AgentCore æ—§APIâ†’æ–°APIç§»è¡Œã‚¬ã‚¤ãƒ‰

  ```markdown
  # bedrock-agentcore-api-migration-guide

  AgentCore æ—§APIâ†’æ–°APIç§»è¡Œãƒ‘ã‚¿ãƒ¼ãƒ³ã€‚ç·Šæ€¥ãƒã‚°ä¿®æ­£ã§å¾—ãŸçŸ¥è¦‹ã‚’ã¾ã¨ã‚ãŸã‚¹ã‚­ãƒ«ã«ã‚ƒã€‚

  ## ä½¿ç”¨ã‚¿ã‚¤ãƒŸãƒ³ã‚°
  - AgentCore ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆã§ ModuleNotFoundError ãŒç™ºç”Ÿã—ãŸæ™‚
  - æ—§APIã‹ã‚‰æ–°APIã¸ç§»è¡Œã™ã‚‹æ™‚
  - Memory API ã‚’ä½¿ç”¨ã™ã‚‹æ™‚

  ## ä¸»ãªç§»è¡Œãƒ‘ã‚¿ãƒ¼ãƒ³

  ### 1. ã‚¤ãƒ³ãƒãƒ¼ãƒˆä¿®æ­£

  **æ—§APIï¼ˆé–“é•ã„ï¼‰**:
  ```python
  from bedrock_agentcore import BedrockAgentCoreApp
  from bedrock_agentcore.context import RequestContext
  ```

  **æ–°APIï¼ˆæ­£è§£ï¼‰**:
  ```python
  from bedrock_agentcore.runtime import BedrockAgentCoreApp
  # RequestContext ã¯å­˜åœ¨ã—ãªã„ï¼ˆå‰Šé™¤ï¼‰
  ```

  ### 2. ã‚¨ãƒ³ãƒˆãƒªãƒ¼ãƒã‚¤ãƒ³ãƒˆé–¢æ•°

  **æ—§APIï¼ˆé–“é•ã„ï¼‰**:
  ```python
  @app.entrypoint
  def main(payload, context: RequestContext):
      session_id = context.session_id
  ```

  **æ–°APIï¼ˆæ­£è§£ï¼‰**:
  ```python
  @app.entrypoint
  def invoke(payload, context):
      session_id = getattr(context, 'session_id', None) or payload.get("session_id", "default-session")
  ```

  **é‡è¦**: é–¢æ•°åã‚’ `main` â†’ `invoke` ã«å¤‰æ›´ã™ã‚‹ã“ã¨ï¼

  ### 3. Memory API ç§»è¡Œ

  **æ—§APIï¼ˆé–“é•ã„ï¼‰**:
  ```python
  from bedrock_agentcore.memory.session import MemorySessionManager
  from bedrock_agentcore.memory.constants import ConversationalMessage, MessageRole
  from bedrock_agentcore.memory import MemoryManager

  # ä¼šè©±å±¥æ­´å–å¾—
  session = get_session_manager(session_id)
  turns = session.get_last_k_turns(k=3)

  # ä¼šè©±ä¿å­˜
  messages = [ConversationalMessage(content, MessageRole.USER)]
  session.add_turns(messages=messages)
  ```

  **æ–°APIï¼ˆæ­£è§£ï¼‰**:
  ```python
  from bedrock_agentcore.memory import MemoryClient
  import os

  memory_client = MemoryClient(region_name='ap-northeast-1')
  MEMORY_ID = os.getenv('MEMORY_ID')

  # ä¼šè©±å±¥æ­´å–å¾—
  turns = memory_client.get_last_k_turns(
      memory_id=MEMORY_ID,
      actor_id="user",
      session_id=session_id,
      k=3
  )

  # ä¼šè©±ä¿å­˜
  messages = [(user_message, "USER"), (agent_response, "ASSISTANT")]
  memory_client.create_event(
      memory_id=MEMORY_ID,
      actor_id="user",
      session_id=session_id,
      messages=messages
  )
  ```

  ### 4. ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸å½¢å¼ã®å¤‰æ›´

  | é …ç›® | æ—§API | æ–°API |
  |------|-------|-------|
  | å½¢å¼ | ConversationalMessage ã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆ | ã‚¿ãƒ—ãƒ« (content, role) |
  | Role | MessageRole.USER / MessageRole.ASSISTANT | "USER" / "ASSISTANT" (æ–‡å­—åˆ—) |
  | ãƒ¡ã‚½ãƒƒãƒ‰ | session.add_turns() | memory_client.create_event() |
  | å±¥æ­´å–å¾— | session.get_last_k_turns() | memory_client.get_last_k_turns() |

  ### 5. ç’°å¢ƒå¤‰æ•°å¯¾å¿œ

  **é‡è¦**: MEMORY_ID ã¯ç’°å¢ƒå¤‰æ•°ã§æ¸¡ã™å¿…è¦ãŒã‚ã‚‹

  ```bash
  # ãƒ‡ãƒ—ãƒ­ã‚¤å‰ã«è¨­å®š
  export MEMORY_ID="<your_memory_id>"
  agentcore launch
  ```

  ## ãƒã‚§ãƒƒã‚¯ãƒªã‚¹ãƒˆ

  ç§»è¡Œå‰ã«ä»¥ä¸‹ã‚’ç¢ºèªã›ã‚ˆï¼š

  - [ ] ã‚¤ãƒ³ãƒãƒ¼ãƒˆã‚’ `bedrock_agentcore.runtime` ã«ä¿®æ­£
  - [ ] RequestContext ã‚’å‰Šé™¤
  - [ ] é–¢æ•°åã‚’ `main` â†’ `invoke` ã«å¤‰æ›´
  - [ ] session_id å–å¾—ã‚’ `getattr()` ã«å¤‰æ›´
  - [ ] MemoryClient ã‚’ä½¿ç”¨
  - [ ] ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸å½¢å¼ã‚’ã‚¿ãƒ—ãƒ«ã«å¤‰æ›´
  - [ ] Role ã‚’æ–‡å­—åˆ—ã«å¤‰æ›´ï¼ˆ"USER", "ASSISTANT"ï¼‰
  - [ ] MEMORY_ID ã‚’ç’°å¢ƒå¤‰æ•°ã§æ¸¡ã™
  - [ ] å…¬å¼ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆã§æœ€æ–°APIã‚’ç¢ºèª

  ## å‚è€ƒè³‡æ–™

  - Bedrock AgentCore å…¬å¼ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆ
  - Memory API ãƒªãƒ•ã‚¡ãƒ¬ãƒ³ã‚¹
  ```

  ### 2. bedrock-agentcore-deployment-guideï¼ˆ18/20ï¼‰

  **ä¿å­˜å…ˆ**: ~/.claude/skills/bedrock-agentcore-deployment-guide/SKILL.md

  **å†…å®¹**:
  AgentCore CLI ãƒ‡ãƒ—ãƒ­ã‚¤æ‰‹é †ãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆ

  ```markdown
  # bedrock-agentcore-deployment-guide

  Amazon Bedrock AgentCore ã‚¨ãƒ¼ã‚¸ã‚§ãƒ³ãƒˆã®ãƒ‡ãƒ—ãƒ­ã‚¤æ‰‹é †ãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆã€‚Phase 4ã§ä½œæˆã—ãŸå®Œå…¨æ‰‹é †ã‚’ã‚¹ã‚­ãƒ«åŒ–ã—ãŸã«ã‚ƒã€‚

  ## ä½¿ç”¨ã‚¿ã‚¤ãƒŸãƒ³ã‚°
  - AgentCore ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆã‚’ãƒ‡ãƒ—ãƒ­ã‚¤ã™ã‚‹æ™‚
  - Lambda + AgentCore Runtime ã‚’çµ±åˆã™ã‚‹æ™‚
  - LINE Bot ã¨ AgentCore ã‚’é€£æºã™ã‚‹æ™‚

  ## å‰ææ¡ä»¶

  - AWS CLI è¨­å®šæ¸ˆã¿
  - Node.js 18+ ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«æ¸ˆã¿
  - Python 3.11+ ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«æ¸ˆã¿
  - AWS CDK CLI ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«æ¸ˆã¿

  ## ãƒ‡ãƒ—ãƒ­ã‚¤æ‰‹é †ï¼ˆå…¨10ã‚¹ãƒ†ãƒƒãƒ—ï¼‰

  ### ã‚¹ãƒ†ãƒƒãƒ—1: Lambda Layer ä½œæˆ

  ```bash
  cd output/{project-name}
  mkdir -p lambda-layer/python
  pip install -r lambda/requirements.txt -t lambda-layer/python
  ```

  **é‡è¦**: Lambda Layer ã¯æ‰‹å‹•ã§ä½œæˆã™ã‚‹å¿…è¦ãŒã‚ã‚‹

  ### ã‚¹ãƒ†ãƒƒãƒ—2: AgentCore CLI ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«

  ```bash
  pip install bedrock-agentcore-starter-toolkit
  ```

  ### ã‚¹ãƒ†ãƒƒãƒ—3: Memory ãƒªã‚½ãƒ¼ã‚¹ä½œæˆ

  ```bash
  cd agent
  agentcore memory create {ProjectName}Memory \
    --strategies '[{"semanticMemoryStrategy": {"name": "UserPreferences"}}]' \
    --region ap-northeast-1 \
    --wait
  ```

  ### ã‚¹ãƒ†ãƒƒãƒ—4: ã‚¨ãƒ¼ã‚¸ã‚§ãƒ³ãƒˆè¨­å®š

  ```bash
  agentcore configure \
    --entrypoint main.py \
    --name {project-name} \
    --runtime PYTHON_3_11 \
    --region ap-northeast-1 \
    --non-interactive
  ```

  ### ã‚¹ãƒ†ãƒƒãƒ—5: ã‚¨ãƒ¼ã‚¸ã‚§ãƒ³ãƒˆãƒ‡ãƒ—ãƒ­ã‚¤

  ```bash
  agentcore launch
  ```

  ### ã‚¹ãƒ†ãƒƒãƒ—6: ã‚¨ãƒ¼ã‚¸ã‚§ãƒ³ãƒˆIDå–å¾—

  ```bash
  agentcore status
  # AGENT_ID ã¨ AGENT_ALIAS_ID ã‚’ãƒ¡ãƒ¢
  ```

  ### ã‚¹ãƒ†ãƒƒãƒ—7: CDKã‚¹ã‚¿ãƒƒã‚¯ãƒ‡ãƒ—ãƒ­ã‚¤

  ```bash
  cd ../infra
  export AGENT_ID="<å–å¾—ã—ãŸAGENT_ID>"
  export AGENT_ALIAS_ID="<å–å¾—ã—ãŸAGENT_ALIAS_ID>"
  npm install
  npx cdk deploy
  ```

  ### ã‚¹ãƒ†ãƒƒãƒ—8: Lambda Function URL å–å¾—

  CDKãƒ‡ãƒ—ãƒ­ã‚¤å¾Œã€Outputs ã‹ã‚‰ Function URL ã‚’ãƒ¡ãƒ¢ï¼š
  ```
  {ProjectName}Stack.LineWebhookFunctionUrl = https://xxxxx.lambda-url.ap-northeast-1.on.aws/
  ```

  ### ã‚¹ãƒ†ãƒƒãƒ—9: LINE Developers ã§ Webhook URL è¨­å®š

  1. LINE Developers Console ã«ãƒ­ã‚°ã‚¤ãƒ³
  2. ãƒãƒ£ãƒãƒ«ã‚’é¸æŠ
  3. Messaging API è¨­å®š > Webhook URL ã« Lambda Function URL ã‚’è¨­å®š
  4. ã€ŒWebhookã®åˆ©ç”¨ã€ã‚’ONã«ã™ã‚‹
  5. ã€Œæ¤œè¨¼ã€ã‚’ã‚¯ãƒªãƒƒã‚¯ã—ã¦ç–é€šç¢ºèª

  ### ã‚¹ãƒ†ãƒƒãƒ—10: å‹•ä½œãƒ†ã‚¹ãƒˆ

  1. LINEå…¬å¼ã‚¢ã‚«ã‚¦ãƒ³ãƒˆã‚’å‹ã ã¡è¿½åŠ 
  2. ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’é€ä¿¡
  3. CloudWatch Logs ã§å‹•ä½œç¢ºèª
     ```bash
     aws logs tail /aws/lambda/{ProjectName}Stack-LineWebhookFunction --follow
     ```

  ## CDKã‚¹ã‚¿ãƒƒã‚¯ä¾‹

  ```typescript
  import * as lambda from 'aws-cdk-lib/aws-lambda';
  import * as path from 'path';

  // Lambda Layer for Python dependencies
  const pythonDepsLayer = new lambda.LayerVersion(this, 'PythonDepsLayer', {
    code: lambda.Code.fromAsset(path.join(__dirname, '../../lambda-layer')),
    compatibleRuntimes: [lambda.Runtime.PYTHON_3_11],
    description: 'Python dependencies (line-bot-sdk, boto3)',
  });

  // Lambda Function
  const webhookFunction = new lambda.Function(this, 'LineWebhookFunction', {
    runtime: lambda.Runtime.PYTHON_3_11,
    handler: 'handler.lambda_handler',
    code: lambda.Code.fromAsset(path.join(__dirname, '../../lambda')),
    timeout: Duration.seconds(60),
    role: lambdaRole,
    layers: [pythonDepsLayer],
    environment: {
      AGENT_ID: process.env.AGENT_ID || 'PLACEHOLDER_AGENT_ID',
      AGENT_ALIAS_ID: process.env.AGENT_ALIAS_ID || 'PLACEHOLDER_AGENT_ALIAS_ID',
    },
    description: 'LINE Webhook to Bedrock AgentCore',
  });
  ```

  ## ãƒˆãƒ©ãƒ–ãƒ«ã‚·ãƒ¥ãƒ¼ãƒ†ã‚£ãƒ³ã‚°

  ### Lambda ã‚¿ã‚¤ãƒ ã‚¢ã‚¦ãƒˆ
  - CloudWatch Logs ã§å®Ÿè¡Œæ™‚é–“ã‚’ç¢ºèª
  - AgentCore ã®å¿œç­”ãŒé…ã„å ´åˆã¯ timeout ã‚’å»¶é•·

  ### LINEç½²åæ¤œè¨¼ã‚¨ãƒ©ãƒ¼
  - Secrets Manager ã«æ­£ã—ã„ãƒãƒ£ãƒãƒ«ã‚·ãƒ¼ã‚¯ãƒ¬ãƒƒãƒˆãŒç™»éŒ²ã•ã‚Œã¦ã„ã‚‹ã‹ç¢ºèª
  - `X-Line-Signature` ãƒ˜ãƒƒãƒ€ãƒ¼ãŒæ­£ã—ãæ¸¡ã•ã‚Œã¦ã„ã‚‹ã‹ç¢ºèª

  ### AgentCore Runtime ã‚¨ãƒ©ãƒ¼
  - AGENT_ID, AGENT_ALIAS_ID ãŒæ­£ã—ãè¨­å®šã•ã‚Œã¦ã„ã‚‹ã‹ç¢ºèª
  - AgentCore ã®ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹ã‚’ç¢ºèª: `agentcore status`
  - Memory ãƒªã‚½ãƒ¼ã‚¹ãŒä½œæˆã•ã‚Œã¦ã„ã‚‹ã‹ç¢ºèª

  ### Memoryæ©Ÿèƒ½ãŒå‹•ä½œã—ãªã„
  - Memory ãƒªã‚½ãƒ¼ã‚¹ãŒä½œæˆã•ã‚Œã¦ã„ã‚‹ã‹ç¢ºèª
  - session_idï¼ˆLINE user_idï¼‰ãŒæ­£ã—ãæ¸¡ã•ã‚Œã¦ã„ã‚‹ã‹ç¢ºèª
  - CloudWatch Logs ã§Memoryé–¢é€£ã‚¨ãƒ©ãƒ¼ã‚’ç¢ºèª

  ## ãƒã‚§ãƒƒã‚¯ãƒªã‚¹ãƒˆ

  - [ ] Lambda Layer ä½œæˆå®Œäº†
  - [ ] AgentCore CLI ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«å®Œäº†
  - [ ] Memory ãƒªã‚½ãƒ¼ã‚¹ä½œæˆå®Œäº†
  - [ ] agentcore configure å®Ÿè¡Œå®Œäº†
  - [ ] agentcore launch å®Ÿè¡Œå®Œäº†
  - [ ] AGENT_ID, AGENT_ALIAS_ID å–å¾—å®Œäº†
  - [ ] CDKã‚¹ã‚¿ãƒƒã‚¯ãƒ‡ãƒ—ãƒ­ã‚¤å®Œäº†
  - [ ] Lambda Function URL å–å¾—å®Œäº†
  - [ ] LINE Webhook URL è¨­å®šå®Œäº†
  - [ ] å‹•ä½œãƒ†ã‚¹ãƒˆæˆåŠŸ
  ```

  ### 3. line-bot-bedrock-agentcore-integrationï¼ˆ18/20ï¼‰

  **ä¿å­˜å…ˆ**: ~/.claude/skills/line-bot-bedrock-agentcore-integration/SKILL.md

  **å†…å®¹**:
  LINE Bot ã¨ Bedrock AgentCore Runtime ã®çµ±åˆãƒ‘ã‚¿ãƒ¼ãƒ³

  ```markdown
  # line-bot-bedrock-agentcore-integration

  LINE Messaging API ã¨ Amazon Bedrock AgentCore Runtime ã‚’çµ±åˆã™ã‚‹ãƒ‘ã‚¿ãƒ¼ãƒ³ã€‚Phase 3ã§å®Ÿè£…ã—ãŸLambda Webhookã‚’ã‚¹ã‚­ãƒ«åŒ–ã—ãŸã«ã‚ƒã€‚

  ## ä½¿ç”¨ã‚¿ã‚¤ãƒŸãƒ³ã‚°
  - LINE Bot ã‚’ AgentCore ã¨é€£æºã™ã‚‹æ™‚
  - Webhook å‡¦ç†ã‚’å®Ÿè£…ã™ã‚‹æ™‚
  - ã‚»ãƒƒã‚·ãƒ§ãƒ³IDé€£æºã§Memoryæ©Ÿèƒ½ã‚’æœ‰åŠ¹åŒ–ã™ã‚‹æ™‚

  ## ã‚¢ãƒ¼ã‚­ãƒ†ã‚¯ãƒãƒ£

  ```
  LINE User â†’ LINE Messaging API â†’ Lambda Function URL â†’ Bedrock AgentCore Runtime
                                    â†“
                               Secrets Manager
  ```

  ## å®Ÿè£…ãƒ‘ã‚¿ãƒ¼ãƒ³

  ### 1. Lambda handler.py ã®åŸºæœ¬æ§‹é€ 

  ```python
  import os
  import json
  import boto3
  from linebot.v3 import WebhookHandler
  from linebot.v3.exceptions import InvalidSignatureError
  from linebot.v3.messaging import Configuration, ApiClient, MessagingApi, ReplyMessageRequest, TextMessage
  from linebot.v3.webhooks import MessageEvent, TextMessageContent

  # Secrets Manager ã‹ã‚‰å–å¾—
  CHANNEL_SECRET = get_secret("LINE_CHANNEL_SECRET")
  CHANNEL_ACCESS_TOKEN = get_secret("LINE_CHANNEL_ACCESS_TOKEN")

  # ç’°å¢ƒå¤‰æ•°ã‹ã‚‰å–å¾—
  AGENT_ID = os.environ["AGENT_ID"]
  AGENT_ALIAS_ID = os.environ["AGENT_ALIAS_ID"]

  bedrock_client = boto3.client("bedrock-agent-runtime", region_name="ap-northeast-1")
  handler = WebhookHandler(CHANNEL_SECRET)

  def lambda_handler(event, context):
      # LINEç½²åæ¤œè¨¼
      signature = event["headers"].get("X-Line-Signature", "")
      body = event["body"]

      try:
          handler.handle(body, signature)
          return {"statusCode": 200, "body": "OK"}
      except InvalidSignatureError:
          return {"statusCode": 403, "body": "Invalid signature"}
      except Exception as e:
          print(f"Error: {e}")
          return {"statusCode": 500, "body": "Internal server error"}

  @handler.add(MessageEvent, message=TextMessageContent)
  def handle_message(event: MessageEvent):
      user_id = event.source.user_id
      user_message = event.message.text
      reply_token = event.reply_token

      # AgentCore Runtime å‘¼ã³å‡ºã—ï¼ˆé‡è¦: sessionId=user_idï¼‰
      response = invoke_agentcore_runtime(user_id, user_message)

      # LINEè¿”ä¿¡
      send_line_reply(reply_token, response)
  ```

  ### 2. LINEç½²åæ¤œè¨¼ï¼ˆã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£å¿…é ˆï¼‰

  ```python
  from linebot.v3 import WebhookHandler
  from linebot.v3.exceptions import InvalidSignatureError

  handler = WebhookHandler(CHANNEL_SECRET)

  # ç½²åæ¤œè¨¼
  try:
      handler.handle(body, signature)
  except InvalidSignatureError:
      # ç½²åæ¤œè¨¼å¤±æ•— â†’ 403 Forbidden
      return {"statusCode": 403, "body": "Invalid signature"}
  ```

  ### 3. AgentCore Runtime å‘¼ã³å‡ºã—

  ```python
  def invoke_agentcore_runtime(user_id: str, user_message: str) -> str:
      """
      Bedrock AgentCore Runtime ã‚’å‘¼ã³å‡ºã—

      é‡è¦: sessionId=user_id ã«ã‚ˆã‚Šä¼šè©±ç¶™ç¶šãŒå¯èƒ½
      """
      response = bedrock_client.invoke_agent(
          agentId=AGENT_ID,
          agentAliasId=AGENT_ALIAS_ID,
          sessionId=user_id,  # â† LINE user_id ã‚’ session_id ã¨ã—ã¦ä½¿ç”¨
          inputText=user_message,
      )

      # ã‚¹ãƒˆãƒªãƒ¼ãƒ å½¢å¼ã®ãƒ¬ã‚¹ãƒãƒ³ã‚¹ã‚’å‡¦ç†
      result = ""
      for event in response.get("completion", []):
          if "chunk" in event:
              chunk = event["chunk"]
              if "bytes" in chunk:
                  result += chunk["bytes"].decode("utf-8")

      return result
  ```

  ### 4. ã‚»ãƒƒã‚·ãƒ§ãƒ³IDé€£æºï¼ˆMemoryæ©Ÿèƒ½æœ‰åŠ¹åŒ–ï¼‰

  **æœ€é‡è¦ãƒã‚¤ãƒ³ãƒˆ**: `sessionId=user_id` ã«ã‚ˆã‚Šã€åŒä¸€LINEãƒ¦ãƒ¼ã‚¶ãƒ¼ã®ä¼šè©±ãŒåŒã˜ã‚»ãƒƒã‚·ãƒ§ãƒ³ã¨ã—ã¦æ‰±ã‚ã‚Œã‚‹

  ```python
  # LINE user_id ã‚’ session_id ã¨ã—ã¦ä½¿ç”¨
  user_id = event.source.user_id

  # AgentCore Runtime ã«æ¸¡ã™
  response = bedrock_client.invoke_agent(
      agentId=AGENT_ID,
      agentAliasId=AGENT_ALIAS_ID,
      sessionId=user_id,  # â† ã“ã‚ŒãŒä¼šè©±ç¶™ç¶šã®éµ
      inputText=user_message,
  )
  ```

  ã“ã‚Œã«ã‚ˆã‚Šï¼š
  - ä¼šè©±å±¥æ­´ã®ä¿æŒ
  - ãƒ¦ãƒ¼ã‚¶ãƒ¼å¥½ã¿ã®è¨˜æ†¶
  - ã€Œã•ã£ãã®2ç•ªç›®ã®åº—ã€ãªã©ã®æŒ‡ç¤ºä»£åè©ã‚’ç†è§£

  ### 5. LINEè¿”ä¿¡

  ```python
  def send_line_reply(reply_token: str, message: str) -> None:
      """LINEè¿”ä¿¡ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸é€ä¿¡"""
      configuration = Configuration(access_token=CHANNEL_ACCESS_TOKEN)

      with ApiClient(configuration) as api_client:
          line_bot_api = MessagingApi(api_client)
          line_bot_api.reply_message(
              ReplyMessageRequest(
                  reply_token=reply_token,
                  messages=[TextMessage(text=message)]
              )
          )
  ```

  ### 6. Secrets Manager é€£æº

  ```python
  def get_secret(secret_name: str) -> str:
      """Secrets Manager ã‹ã‚‰ã‚·ãƒ¼ã‚¯ãƒ¬ãƒƒãƒˆå–å¾—"""
      session = boto3.session.Session()
      client = session.client(service_name="secretsmanager", region_name="ap-northeast-1")

      response = client.get_secret_value(SecretId=secret_name)
      return response["SecretString"]
  ```

  ## requirements.txt

  ```
  line-bot-sdk>=3.0.0
  boto3>=1.34.0
  ```

  ## ãƒã‚§ãƒƒã‚¯ãƒªã‚¹ãƒˆ

  - [ ] LINEç½²åæ¤œè¨¼ã‚’å®Ÿè£…
  - [ ] sessionId=user_id ã§AgentCoreå‘¼ã³å‡ºã—
  - [ ] ã‚¹ãƒˆãƒªãƒ¼ãƒ å½¢å¼ãƒ¬ã‚¹ãƒãƒ³ã‚¹ã‚’å‡¦ç†
  - [ ] Secrets Manager ã‹ã‚‰ã‚·ãƒ¼ã‚¯ãƒ¬ãƒƒãƒˆå–å¾—
  - [ ] ã‚¨ãƒ©ãƒ¼ãƒãƒ³ãƒ‰ãƒªãƒ³ã‚°å®Ÿè£…
  - [ ] CloudWatch Logs å‡ºåŠ›å®Ÿè£…
  - [ ] Lambda Function URL è¨­å®š
  - [ ] LINE Webhook URL è¨­å®š

  ## å‚è€ƒè³‡æ–™

  - LINE Bot SDK for Python v3: https://github.com/line/line-bot-sdk-python
  - Bedrock AgentCore Runtime API: AWSå…¬å¼ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆ
  ```

  ### 4. bedrock-agentcore-memory-integrationï¼ˆ18/20ï¼‰

  **ä¿å­˜å…ˆ**: ~/.claude/skills/bedrock-agentcore-memory-integration/SKILL.md

  **å†…å®¹**:
  AgentCore Memory çµ±åˆãƒ‘ã‚¿ãƒ¼ãƒ³

  ```markdown
  # bedrock-agentcore-memory-integration

  Amazon Bedrock AgentCore Memory çµ±åˆãƒ‘ã‚¿ãƒ¼ãƒ³ã€‚ä¼šè©±ç¶™ç¶šãƒ»æ–‡è„ˆç¶­æŒã‚’å®Ÿç¾ã™ã‚‹ã‚¹ã‚­ãƒ«ã«ã‚ƒã€‚

  ## ä½¿ç”¨ã‚¿ã‚¤ãƒŸãƒ³ã‚°
  - AgentCore ã§ä¼šè©±å±¥æ­´ã‚’ç®¡ç†ã™ã‚‹æ™‚
  - ãƒ¦ãƒ¼ã‚¶ãƒ¼å¥½ã¿ã‚’è¨˜æ†¶ã™ã‚‹æ™‚
  - ã‚»ãƒãƒ³ãƒ†ã‚£ãƒƒã‚¯æ¤œç´¢ã‚’å®Ÿè£…ã™ã‚‹æ™‚

  ## ã‚¢ãƒ¼ã‚­ãƒ†ã‚¯ãƒãƒ£

  ```
  AgentCore Runtime â† Memory Client â†’ Memory Resource
                                       â”œâ”€ ä¼šè©±å±¥æ­´ï¼ˆã‚¿ãƒ¼ãƒ³å½¢å¼ï¼‰
                                       â””â”€ ã‚»ãƒãƒ³ãƒ†ã‚£ãƒƒã‚¯ãƒ¡ãƒ¢ãƒªï¼ˆãƒ¦ãƒ¼ã‚¶ãƒ¼å¥½ã¿ï¼‰
  ```

  ## å®Ÿè£…ãƒ‘ã‚¿ãƒ¼ãƒ³

  ### 1. Memory Client åˆæœŸåŒ–

  ```python
  import os
  from bedrock_agentcore.memory import MemoryClient
  from typing import List, Dict, Any

  # Memory Client åˆæœŸåŒ–ï¼ˆã‚°ãƒ­ãƒ¼ãƒãƒ«ã‚¹ã‚³ãƒ¼ãƒ—ï¼‰
  memory_client = MemoryClient(region_name='ap-northeast-1')
  MEMORY_ID = os.getenv('MEMORY_ID')  # ç’°å¢ƒå¤‰æ•°ã‹ã‚‰å–å¾—

  if not MEMORY_ID:
      raise ValueError("MEMORY_ID environment variable is required")
  ```

  ### 2. ä¼šè©±å±¥æ­´å–å¾—

  ```python
  def get_conversation_history(session_id: str, k: int = 3) -> List[Dict[str, Any]]:
      """
      éå»kä»¶ã®ä¼šè©±å±¥æ­´ã‚’å–å¾—

      Args:
          session_id: ã‚»ãƒƒã‚·ãƒ§ãƒ³IDï¼ˆLINE user_id ãªã©ï¼‰
          k: å–å¾—ä»¶æ•°

      Returns:
          ä¼šè©±å±¥æ­´ã®ãƒªã‚¹ãƒˆ
      """
      try:
          turns = memory_client.get_last_k_turns(
              memory_id=MEMORY_ID,
              actor_id="user",
              session_id=session_id,
              k=k
          )
          return turns if turns else []
      except Exception as e:
          print(f"Failed to retrieve conversation history: {e}")
          return []
  ```

  ### 3. ä¼šè©±ä¿å­˜

  ```python
  def save_conversation(
      session_id: str,
      user_message: str,
      agent_response: str
  ) -> bool:
      """
      ä¼šè©±ã‚’Memoryã«ä¿å­˜

      Args:
          session_id: ã‚»ãƒƒã‚·ãƒ§ãƒ³ID
          user_message: ãƒ¦ãƒ¼ã‚¶ãƒ¼ã®ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸
          agent_response: ã‚¨ãƒ¼ã‚¸ã‚§ãƒ³ãƒˆã®å¿œç­”

      Returns:
          ä¿å­˜æˆåŠŸ = True
      """
      try:
          # ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’ã‚¿ãƒ—ãƒ«ã®ãƒªã‚¹ãƒˆã¨ã—ã¦ä½œæˆ
          messages = [
              (user_message, "USER"),
              (agent_response, "ASSISTANT")
          ]

          memory_client.create_event(
              memory_id=MEMORY_ID,
              actor_id="user",
              session_id=session_id,
              messages=messages
          )
          return True
      except Exception as e:
          print(f"Failed to save conversation: {e}")
          return False
  ```

  ### 4. ã‚»ãƒãƒ³ãƒ†ã‚£ãƒƒã‚¯æ¤œç´¢

  ```python
  def search_semantic_memory(
      session_id: str,
      query: str
  ) -> List[Dict[str, Any]]:
      """
      ã‚»ãƒãƒ³ãƒ†ã‚£ãƒƒã‚¯ãƒ¡ãƒ¢ãƒªã‚’æ¤œç´¢ï¼ˆãƒ¦ãƒ¼ã‚¶ãƒ¼ã®å¥½ã¿ãªã©ï¼‰

      Args:
          session_id: ã‚»ãƒƒã‚·ãƒ§ãƒ³ID
          query: æ¤œç´¢ã‚¯ã‚¨ãƒª

      Returns:
          é–¢é€£ã™ã‚‹ãƒ¡ãƒ¢ãƒªã®ãƒªã‚¹ãƒˆ
      """
      try:
          # æ–°APIã§ã¯ã‚»ãƒãƒ³ãƒ†ã‚£ãƒƒã‚¯æ¤œç´¢ã¯ get_last_k_turns ã§ä»£ç”¨
          # ã¾ãŸã¯åˆ¥ã®ãƒ¡ã‚½ãƒƒãƒ‰ã‚’ä½¿ç”¨ï¼ˆå…¬å¼ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆç¢ºèªï¼‰
          return []
      except Exception as e:
          print(f"Failed to search semantic memory: {e}")
          return []
  ```

  ### 5. main.py ã§ã® Memory çµ±åˆ

  ```python
  from bedrock_agentcore.runtime import BedrockAgentCoreApp
  from utils.memory import get_conversation_history, save_conversation

  app = BedrockAgentCoreApp()

  @app.entrypoint
  def invoke(payload, context):
      """
      ã‚¨ãƒ¼ã‚¸ã‚§ãƒ³ãƒˆã®ã‚¨ãƒ³ãƒˆãƒªãƒ¼ãƒã‚¤ãƒ³ãƒˆ

      Args:
          payload: ãƒªã‚¯ã‚¨ã‚¹ãƒˆãƒšã‚¤ãƒ­ãƒ¼ãƒ‰ï¼ˆdictï¼‰
          context: AgentCoreå®Ÿè¡Œã‚³ãƒ³ãƒ†ã‚­ã‚¹ãƒˆ
      """
      # session_id ã®å–å¾—
      session_id = getattr(context, 'session_id', None) or payload.get("session_id", "default-session")
      user_message = payload.get("user_message", "") or payload.get("prompt", "")

      # ä¼šè©±å±¥æ­´å–å¾—
      history = get_conversation_history(session_id, k=3)
      history_text = format_conversation_history(history)

      # instructions ã«ä¼šè©±å±¥æ­´ã‚’å«ã‚ã‚‹
      instructions = f"""
      ã‚ãªãŸã¯è¦ªåˆ‡ãªã‚¢ã‚·ã‚¹ã‚¿ãƒ³ãƒˆã§ã™ã€‚

      éå»ã®ä¼šè©±:
      {history_text}

      ãƒ¦ãƒ¼ã‚¶ãƒ¼ã®è³ªå•: {user_message}
      """

      # ã‚¨ãƒ¼ã‚¸ã‚§ãƒ³ãƒˆå‡¦ç†ï¼ˆçœç•¥ï¼‰
      agent_response = process_agent(instructions)

      # Memory ã«ä¿å­˜
      save_conversation(session_id, user_message, agent_response)

      return agent_response

  def format_conversation_history(turns: List[Dict]) -> str:
      """ä¼šè©±å±¥æ­´ã‚’ãƒ•ã‚©ãƒ¼ãƒãƒƒãƒˆ"""
      if not turns:
          return "ï¼ˆåˆå›ã®ä¼šè©±ã§ã™ï¼‰"

      formatted = []
      for turn in turns[-5:]:  # ç›´è¿‘5ä»¶
          messages = turn.get('messages', [])
          for msg in messages:
              role = msg.get('role', 'unknown')
              content = msg.get('content', '')
              if role == 'USER':
                  formatted.append(f"ãƒ¦ãƒ¼ã‚¶ãƒ¼: {content}")
              elif role == 'ASSISTANT':
                  formatted.append(f"ã‚¨ãƒ¼ã‚¸ã‚§ãƒ³ãƒˆ: {content}")
      return "\n".join(formatted)
  ```

  ## Memory Resource ä½œæˆ

  ```bash
  agentcore memory create {ProjectName}Memory \
    --strategies '[{"semanticMemoryStrategy": {"name": "UserPreferences"}}]' \
    --region ap-northeast-1 \
    --wait
  ```

  ## ç’°å¢ƒå¤‰æ•°è¨­å®š

  ```bash
  # ãƒ‡ãƒ—ãƒ­ã‚¤å‰ã«è¨­å®š
  export MEMORY_ID="<å–å¾—ã—ãŸMEMORY_ID>"
  agentcore launch
  ```

  ## ãƒã‚§ãƒƒã‚¯ãƒªã‚¹ãƒˆ

  - [ ] Memory Resource ä½œæˆå®Œäº†
  - [ ] MEMORY_ID ç’°å¢ƒå¤‰æ•°è¨­å®š
  - [ ] MemoryClient åˆæœŸåŒ–å®Ÿè£…
  - [ ] get_conversation_history å®Ÿè£…
  - [ ] save_conversation å®Ÿè£…
  - [ ] main.py ã« Memory çµ±åˆ
  - [ ] session_id ã‚’æ­£ã—ãæ¸¡ã™
  - [ ] ã‚¨ãƒ©ãƒ¼ãƒãƒ³ãƒ‰ãƒªãƒ³ã‚°å®Ÿè£…

  ## å‚è€ƒè³‡æ–™

  - Bedrock AgentCore Memory API ãƒªãƒ•ã‚¡ãƒ¬ãƒ³ã‚¹
  - AWSå…¬å¼ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆ
  ```

  ## æ³¨æ„äº‹é …

  - å…¨ã‚¹ã‚­ãƒ«ã¯ Claude Code Skills å½¢å¼ï¼ˆSKILL.mdï¼‰ã§ä½œæˆã«ã‚ƒ
  - ä¿å­˜å…ˆã¯ ~/.claude/skills/{skill-name}/SKILL.md ã«ã‚ƒ
  - å‹ãƒ’ãƒ³ãƒˆãƒ»ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆæ–‡å­—åˆ—ã‚’å…¨é–¢æ•°ã«ä»˜ä¸ã«ã‚ƒ
  - ã‚³ãƒ¼ãƒ‰ãƒ–ãƒ­ãƒƒã‚¯ã¯ ```python ã¾ãŸã¯ ```typescript ã§å›²ã‚€ã«ã‚ƒ
  - å®Ÿè£…ä¾‹ã¯å®Ÿéš›ã®Phase 2ã€œ4ã®æˆæœç‰©ã‚’å‚è€ƒã«ã™ã‚‹ã«ã‚ƒ

context:
  skill_base_dir: "~/.claude/skills"
  reference_files:
    - "output/izakaya-agent/agent/main.py"
    - "output/izakaya-agent/agent/utils/memory.py"
    - "output/izakaya-agent/lambda/handler.py"
    - "output/izakaya-agent/infra/lib/izakaya-stack.ts"
    - "output/izakaya-agent/README.md"
expected_outputs:
  - "~/.claude/skills/bedrock-agentcore-api-migration-guide/SKILL.md"
  - "~/.claude/skills/bedrock-agentcore-deployment-guide/SKILL.md"
  - "~/.claude/skills/line-bot-bedrock-agentcore-integration/SKILL.md"
  - "~/.claude/skills/bedrock-agentcore-memory-integration/SKILL.md"
  - "queue/reports/report-task-20260206-024004-kitten1.yaml"
