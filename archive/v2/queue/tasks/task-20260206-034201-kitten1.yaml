task_id: "task-20260206-034201-kitten1"
assigned_to: "kitten1"
timestamp: "2026-02-06T03:42:01"
priority: urgent
load_skills: []
description: |
  ## ğŸš¨ Lambda handler.py ã‚’ AgentCore Runtime API ã«æ›¸ãæ›ãˆï¼ˆã‚¿ã‚¹ã‚¯1+2ï¼‰

  ç¾åœ¨ã® Lambda handler.py ã¯ **bedrock-agent-runtime** API ã‚’ä½¿ç”¨ã—ã¦ã„ã‚‹ãŒã€
  ãƒ‡ãƒ—ãƒ­ã‚¤ã—ãŸã‚¨ãƒ¼ã‚¸ã‚§ãƒ³ãƒˆã¯ **AgentCore Runtime** ãªã®ã§ã€API ãŒç•°ãªã‚‹ã«ã‚ƒã€‚
  æ­£ã—ã„ AgentCore Runtime HTTP POST API ã«æ›¸ãæ›ãˆã‚‹ã«ã‚ƒã€œã€‚

  ## èƒŒæ™¯

  - ç¾åœ¨ã®ã‚³ãƒ¼ãƒ‰: `bedrock-agent-runtime` ã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆ + `invoke_agent` é–¢æ•°
  - æ­£ã—ã„ã‚¢ãƒ—ãƒ­ãƒ¼ãƒ: AgentCore Runtime HTTP POST `/invocations` + SigV4 èªè¨¼

  ## ä½œæ¥­ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒª

  `/home/edgesakura/neko-pm/output/izakaya-agent/`

  ## ã‚¿ã‚¹ã‚¯1: handler.py ã®ä¿®æ­£

  **ãƒ•ã‚¡ã‚¤ãƒ«**: `lambda/handler.py`

  ### ä¿®æ­£å†…å®¹

  1. **ã‚¤ãƒ³ãƒãƒ¼ãƒˆè¿½åŠ **
     ```python
     import requests
     from urllib.parse import quote
     from botocore.auth import SigV4Auth
     from botocore.awsrequest import AWSRequest
     ```

  2. **ç’°å¢ƒå¤‰æ•°å¤‰æ›´**
     ```python
     # å‰Šé™¤
     AGENT_ID = os.environ.get("AGENT_ID")
     AGENT_ALIAS_ID = os.environ.get("AGENT_ALIAS_ID")

     # è¿½åŠ 
     RUNTIME_ARN = os.environ.get("RUNTIME_ARN")
     REGION = "ap-northeast-1"
     ```

  3. **bedrock-agent-runtime ã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆã‚’å‰Šé™¤**
     ```python
     # å‰Šé™¤
     bedrock_client = boto3.client("bedrock-agent-runtime", region_name=REGION)
     ```

  4. **invoke_agentcore_runtime é–¢æ•°ã‚’æ›¸ãæ›ãˆ**
     ```python
     def get_data_plane_endpoint(region: str) -> str:
         """AgentCore Runtime ã®ãƒ‡ãƒ¼ã‚¿ãƒ—ãƒ¬ãƒ¼ãƒ³ã‚¨ãƒ³ãƒ‰ãƒã‚¤ãƒ³ãƒˆã‚’å–å¾—"""
         return f"https://bedrock-agentcore-runtime.{region}.amazonaws.com"

     def invoke_agentcore_runtime(user_id: str, user_message: str) -> str:
         """
         AgentCore Runtime ã‚’ HTTP POST + SigV4 ã§å‘¼ã³å‡ºã™

         Args:
             user_id: LINE ãƒ¦ãƒ¼ã‚¶ãƒ¼IDï¼ˆã‚»ãƒƒã‚·ãƒ§ãƒ³IDï¼‰
             user_message: ãƒ¦ãƒ¼ã‚¶ãƒ¼ã‹ã‚‰ã®ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸

         Returns:
             ã‚¨ãƒ¼ã‚¸ã‚§ãƒ³ãƒˆã®å¿œç­”ãƒ†ã‚­ã‚¹ãƒˆ
         """
         # ã‚¨ãƒ³ãƒ‰ãƒã‚¤ãƒ³ãƒˆæ§‹ç¯‰
         endpoint = get_data_plane_endpoint(REGION)
         runtime_arn_encoded = quote(RUNTIME_ARN, safe='')
         url = f"{endpoint}/runtimes/{runtime_arn_encoded}/invocations"

         # ãƒšã‚¤ãƒ­ãƒ¼ãƒ‰
         payload = json.dumps({"prompt": user_message})

         # SigV4 ç½²å
         session = boto3.Session()
         credentials = session.get_credentials().get_frozen_credentials()

         request = AWSRequest(
             method="POST",
             url=url,
             data=payload,
             headers={
                 "Content-Type": "application/json",
                 "X-Amzn-Bedrock-AgentCore-Runtime-Session-Id": user_id,
             }
         )
         SigV4Auth(credentials, "bedrock-agentcore", REGION).add_auth(request)

         # ãƒªã‚¯ã‚¨ã‚¹ãƒˆé€ä¿¡
         response = requests.post(
             url,
             data=payload,
             headers=dict(request.headers),
             timeout=30
         )
         response.raise_for_status()

         # ãƒ¬ã‚¹ãƒãƒ³ã‚¹è§£æ
         response_data = response.json()
         return response_data.get("response", "å¿œç­”ã‚’å–å¾—ã§ãã¾ã›ã‚“ã§ã—ãŸ")
     ```

  5. **å‘¼ã³å‡ºã—éƒ¨åˆ†ã®ä¿®æ­£**
     - `process_message_event` é–¢æ•°å†…ã® `invoke_agentcore_runtime` å‘¼ã³å‡ºã—ã¯å¤‰æ›´ä¸è¦
     - ã‚»ãƒƒã‚·ãƒ§ãƒ³ID = LINE user_id ã®ã¾ã¾ã§OK

  ## ã‚¿ã‚¹ã‚¯2: requirements.txt ã®æ›´æ–°

  **ãƒ•ã‚¡ã‚¤ãƒ«**: `lambda/requirements.txt`

  ### è¿½åŠ å†…å®¹

  ```
  requests>=2.31.0
  ```

  **æ³¨æ„**: boto3 ã¯æ—¢ã«å«ã¾ã‚Œã¦ã„ã‚‹ã¯ãšãªã®ã§ã€è¿½åŠ ä¸è¦

  ## æˆåŠŸåˆ¤å®šåŸºæº–

  ä»¥ä¸‹ã‚’å…¨ã¦æº€ãŸã™å ´åˆã€ã‚¿ã‚¹ã‚¯å®Œäº†ã¨ã™ã‚‹ã«ã‚ƒï¼š

  - [ ] handler.py ã®ã‚¤ãƒ³ãƒãƒ¼ãƒˆè¿½åŠ ï¼ˆrequests, SigV4Auth, AWSRequestï¼‰
  - [ ] ç’°å¢ƒå¤‰æ•°å¤‰æ›´ï¼ˆRUNTIME_ARN è¿½åŠ ã€AGENT_ID/AGENT_ALIAS_ID å‰Šé™¤ï¼‰
  - [ ] bedrock-agent-runtime ã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆå‰Šé™¤
  - [ ] invoke_agentcore_runtime é–¢æ•°æ›¸ãæ›ãˆï¼ˆHTTP POST + SigV4ï¼‰
  - [ ] requirements.txt ã« requests è¿½åŠ 

  ## ã‚¨ãƒ©ãƒ¼ãƒãƒ³ãƒ‰ãƒªãƒ³ã‚°

  ### ã‚¨ãƒ©ãƒ¼1: RUNTIME_ARN ãŒæœªè¨­å®š
  **ç—‡çŠ¶**: `KeyError: 'RUNTIME_ARN'`
  **å¯¾å‡¦æ³•**: CDK ã§ç’°å¢ƒå¤‰æ•°è¨­å®šï¼ˆå­çŒ«2ã®ã‚¿ã‚¹ã‚¯ï¼‰

  ### ã‚¨ãƒ©ãƒ¼2: requests ãƒ¢ã‚¸ãƒ¥ãƒ¼ãƒ«ãŒãªã„
  **ç—‡çŠ¶**: `ModuleNotFoundError: No module named 'requests'`
  **å¯¾å‡¦æ³•**: Lambda Layer ã« requests ã‚’è¿½åŠ ï¼ˆãƒ‡ãƒ—ãƒ­ã‚¤æ™‚ï¼‰

  ### ã‚¨ãƒ©ãƒ¼3: SigV4 ç½²åã‚¨ãƒ©ãƒ¼
  **ç—‡çŠ¶**: `403 Forbidden`
  **å¯¾å‡¦æ³•**: IAM æ¨©é™ç¢ºèªï¼ˆå­çŒ«2ã®ã‚¿ã‚¹ã‚¯ï¼‰

  ## æ³¨æ„äº‹é …

  - RUNTIME_ARN ã¯å­çŒ«2ãŒ CDK ã§è¨­å®šã™ã‚‹
  - requests ãƒ©ã‚¤ãƒ–ãƒ©ãƒªã¯ Lambda Layer ã¾ãŸã¯ pip install ã§è¿½åŠ 
  - ãƒ‡ãƒ—ãƒ­ã‚¤ã¯å­çŒ«1ãƒ»å­çŒ«2ã®ã‚¿ã‚¹ã‚¯å®Œäº†å¾Œã«å®Ÿè¡Œ

context:
  lambda_handler: "/home/edgesakura/neko-pm/output/izakaya-agent/lambda/handler.py"
  lambda_requirements: "/home/edgesakura/neko-pm/output/izakaya-agent/lambda/requirements.txt"
  runtime_arn: "arn:aws:bedrock-agentcore:ap-northeast-1:921563379197:runtime/izakaya_agent-9JGtN3Enat"
  region: "ap-northeast-1"
expected_outputs:
  - "handler.py ä¿®æ­£å®Œäº†"
  - "requirements.txt æ›´æ–°å®Œäº†"
  - "queue/reports/report-task-20260206-034201-kitten1.yaml"
