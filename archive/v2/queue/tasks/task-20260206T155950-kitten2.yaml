task_id: "task-20260206T155950-kitten2"
assigned_to: "kitten2"
timestamp: "2026-02-06T15:59:50"
priority: critical
load_skills: []
description: |
  ğŸš¨ã€CRITICALä¿®æ­£ã€‘ã®ã¿ã¹ã‚ã‚¨ãƒ¼ã‚¸ã‚§ãƒ³ãƒˆ v2 - ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ãƒªã‚¹ã‚¯å…¨ä»¶ä¿®æ­£

  ## èƒŒæ™¯
  ãƒ•ã‚¯ãƒ­ã‚¦ï¼ˆCodex CLIï¼‰ã®ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ãƒ¬ãƒ“ãƒ¥ãƒ¼ã§ã€CRITICAL 1ä»¶ã€HIGH 3ä»¶ã®å•é¡ŒãŒæ¤œå‡ºã•ã‚ŒãŸã«ã‚ƒã€‚
  ãƒœã‚¹ã­ã“ã‹ã‚‰ã®æŒ‡ç¤ºã«ã‚ˆã‚Šã€æœ¬ç•ªæŠ•å…¥å‰ã«å…¨ä»¶ä¿®æ­£ã›ã‚ˆã«ã‚ƒã€‚

  ## ä¿®æ­£æŒ‡ç¤ºï¼ˆå„ªå…ˆåº¦é †ï¼‰

  ### 1. CRITICAL: Lambdaå†…ã§ã‚¤ãƒ™ãƒ³ãƒˆã‚½ãƒ¼ã‚¹æ¤œè¨¼

  **å•é¡Œ**: Lambda Function URLãŒ`authType: NONE`ã§å…¬é–‹ã•ã‚Œã€æœªèªè¨¼ãƒ¦ãƒ¼ã‚¶ãƒ¼ãŒCognitoã‚’è¿‚å›ã—ã¦æ¨è«–å®Ÿè¡Œã§ãã‚‹

  **ä¿®æ­£å†…å®¹**:
  - Lambda handler.py ã«ã‚¤ãƒ™ãƒ³ãƒˆã‚½ãƒ¼ã‚¹æ¤œè¨¼ãƒ­ã‚¸ãƒƒã‚¯ã‚’è¿½åŠ 
  - Function URLã‹ã‚‰ã®ãƒªã‚¯ã‚¨ã‚¹ãƒˆ: LINEç½²åæ¤œè¨¼å¿…é ˆã€ç½²åãªã—ã¯å³åº§ã«æ‹’å¦ï¼ˆ401 Unauthorizedï¼‰
  - Web APIã‹ã‚‰ã®ãƒªã‚¯ã‚¨ã‚¹ãƒˆ: API Gateway + CognitoçµŒç”±ã®ã¿å—ä»˜ã€`requestContext.authorizer.claims`ãŒå­˜åœ¨ã—ãªã„å ´åˆã¯æ‹’å¦

  **å®Ÿè£…ä¾‹**:
  ```python
  def validate_event_source(event):
      # API Gateway + CognitoçµŒç”±ã®å ´åˆ
      if 'requestContext' in event and 'authorizer' in event.get('requestContext', {}):
          if 'claims' in event['requestContext']['authorizer']:
              return 'web_api'  # èªè¨¼æ¸ˆã¿Web APIãƒªã‚¯ã‚¨ã‚¹ãƒˆ

      # Function URLçµŒç”±ï¼ˆLINE Webhookï¼‰ã®å ´åˆ
      if 'headers' in event:
          signature = event['headers'].get('x-line-signature')
          if signature:
              # LINEç½²åæ¤œè¨¼ï¼ˆæ—¢å­˜ã®verify_line_signatureã‚’ä½¿ç”¨ï¼‰
              if verify_line_signature(event, signature):
                  return 'line_webhook'

      # ã©ã¡ã‚‰ã§ã‚‚ãªã„å ´åˆã¯æ‹’å¦
      return None

  def lambda_handler(event, context):
      source = validate_event_source(event)
      if source is None:
          return {
              'statusCode': 401,
              'body': json.dumps({'error': 'Unauthorized'})
          }
      # ä»¥é™ã®å‡¦ç†...
  ```

  ### 2. HIGH-1: user_idã¯Cognitoãƒˆãƒ¼ã‚¯ãƒ³ã®subã‹ã‚‰å¼·åˆ¶å–å¾—

  **å•é¡Œ**: Web APIã§`user_id`ã‚’ãƒœãƒ‡ã‚£ã‹ã‚‰å—ã‘å…¥ã‚Œã¦`runtimeSessionId`ã«ä½¿ç”¨ã€ãªã‚Šã™ã¾ã—å¯èƒ½

  **ä¿®æ­£å†…å®¹**:
  - Web APIã®å ´åˆã€`user_id`ã¯`requestContext.authorizer.claims.sub`ã‹ã‚‰å¼·åˆ¶å–å¾—
  - ãƒªã‚¯ã‚¨ã‚¹ãƒˆãƒœãƒ‡ã‚£ã®`user_id`ã¯ç„¡è¦–

  **å®Ÿè£…ä¾‹**:
  ```python
  def parse_request(event):
      source = validate_event_source(event)

      if source == 'web_api':
          # Cognitoã®`sub`ã‹ã‚‰å¼·åˆ¶å–å¾—
          user_id = event['requestContext']['authorizer']['claims']['sub']
          body = json.loads(event['body'])
          return {
              "message": body['message'],
              "user_id": user_id,  # ãƒœãƒ‡ã‚£ã®user_idã¯ç„¡è¦–
              "source": "web"
          }
      # LINE Webhookã®å ´åˆã¯æ—¢å­˜ãƒ­ã‚¸ãƒƒã‚¯...
  ```

  ### 3. HIGH-2: API Gatewayã®CORSã‚’Amplifyãƒ•ãƒ­ãƒ³ãƒˆã®ã‚ªãƒªã‚¸ãƒ³ã®ã¿ã«åˆ¶é™

  **å•é¡Œ**: `allowOrigins: *`ã§å…¨ã‚ªãƒªã‚¸ãƒ³è¨±å¯ã€ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ãƒªã‚¹ã‚¯

  **ä¿®æ­£å†…å®¹**:
  - infra/lib/izakaya-stack.ts ã®CORSè¨­å®šã‚’ä¿®æ­£
  - ãƒ•ãƒ­ãƒ³ãƒˆã‚¨ãƒ³ãƒ‰URLç¢ºå®šå¾Œã«åˆ¶é™ï¼ˆç¾åœ¨ã¯é–‹ç™ºä¸­ãªã®ã§`http://localhost:3001`ã®ã¿è¨±å¯ï¼‰

  **å®Ÿè£…ä¾‹**:
  ```typescript
  // izakaya-stack.ts
  const chatResource = api.root.addResource('chat');
  chatResource.addMethod('POST', new apigateway.LambdaIntegration(webhookLambda), {
    authorizer: cognitoAuthorizer,
    methodResponses: [
      {
        statusCode: '200',
        responseParameters: {
          'method.response.header.Access-Control-Allow-Origin': true,
          'method.response.header.Access-Control-Allow-Headers': true,
        },
      },
    ],
  });

  chatResource.addCorsPreflight({
    allowOrigins: ['http://localhost:3001'],  // ãƒ•ãƒ­ãƒ³ãƒˆã‚¨ãƒ³ãƒ‰URLï¼ˆæœ¬ç•ªæ™‚ã¯ç¢ºå®šURLã«å¤‰æ›´ï¼‰
    allowMethods: ['POST', 'OPTIONS'],
    allowHeaders: ['Content-Type', 'Authorization'],
  });
  ```

  ### 4. HIGH-3: Function URLã®CORSè¨­å®šå‰Šé™¤

  **å•é¡Œ**: Webhookç”¨é€”ã«CORSä¸è¦ãªã®ã«å…¨ã‚ªãƒªã‚¸ãƒ³è¨±å¯ã€ãƒ–ãƒ©ã‚¦ã‚¶èµ·ç‚¹ã§ã®æ‚ªç”¨å®¹æ˜“åŒ–

  **ä¿®æ­£å†…å®¹**:
  - infra/lib/izakaya-stack.ts ã®Function URLè¨­å®šã‹ã‚‰CORSè¨­å®šã‚’å‰Šé™¤

  **å®Ÿè£…ä¾‹**:
  ```typescript
  // izakaya-stack.ts
  const functionUrl = webhookLambda.addFunctionUrl({
    authType: lambda.FunctionUrlAuthType.NONE,
    // cors è¨­å®šã‚’å‰Šé™¤ï¼ˆä»¥ä¸‹ã‚’å‰Šé™¤ï¼‰
    // cors: { ... }
  });
  ```

  ## æ¤œè¨¼æ‰‹é †

  1. **ä¿®æ­£å®Ÿæ–½**
     - lambda/handler.py ã®ä¿®æ­£
     - infra/lib/izakaya-stack.ts ã®ä¿®æ­£

  2. **ãƒ‡ãƒ—ãƒ­ã‚¤**
     ```bash
     # AgentCoreå†ãƒ‡ãƒ—ãƒ­ã‚¤ï¼ˆhandler.pyå¤‰æ›´åæ˜ ï¼‰
     cd output/izakaya-agent/agent
     source .venv/bin/activate
     agentcore deploy

     # CDKå†ãƒ‡ãƒ—ãƒ­ã‚¤ï¼ˆizakaya-stack.tså¤‰æ›´åæ˜ ï¼‰
     cd ../infra
     npx cdk deploy
     ```

  3. **å‹•ä½œç¢ºèª**
     - LINE Webhook: æ­£å¸¸å‹•ä½œã‚’ç¢ºèª
     - Web APIï¼ˆæœªèªè¨¼ï¼‰: 401 UnauthorizedãŒè¿”ã‚‹ã“ã¨ã‚’ç¢ºèª
     - Web APIï¼ˆCognitoèªè¨¼æ¸ˆã¿ï¼‰: æ­£å¸¸å‹•ä½œã‚’ç¢ºèª
     - CORS: è¨±å¯ã•ã‚ŒãŸã‚ªãƒªã‚¸ãƒ³ã®ã¿ã‚¢ã‚¯ã‚»ã‚¹å¯èƒ½ã‚’ç¢ºèª

  ## æˆæœç‰©

  - lambda/handler.pyï¼ˆã‚¤ãƒ™ãƒ³ãƒˆã‚½ãƒ¼ã‚¹æ¤œè¨¼ã€user_idå¼·åˆ¶å–å¾—ï¼‰
  - infra/lib/izakaya-stack.tsï¼ˆCORSåˆ¶é™ã€Function URL CORSå‰Šé™¤ï¼‰
  - å‹•ä½œç¢ºèªçµæœãƒ¬ãƒãƒ¼ãƒˆ
  - ãƒ•ã‚¯ãƒ­ã‚¦ã«ã‚ˆã‚‹å†ãƒ¬ãƒ“ãƒ¥ãƒ¼çµæœï¼ˆPASSEDç¢ºèªï¼‰

context:
  service_name: "izakaya-agent"
  project_dir: "output/izakaya-agent"
  region: "ap-northeast-1"
  references:
    - "lambda/handler.py"
    - "infra/lib/izakaya-stack.ts"
    - "CLAUDE.md"

expected_outputs:
  - "lambda/handler.pyï¼ˆã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ä¿®æ­£ç‰ˆï¼‰"
  - "infra/lib/izakaya-stack.tsï¼ˆCORSåˆ¶é™ç‰ˆï¼‰"
  - "AgentCoreå†ãƒ‡ãƒ—ãƒ­ã‚¤å®Œäº†"
  - "CDKå†ãƒ‡ãƒ—ãƒ­ã‚¤å®Œäº†"
  - "å‹•ä½œç¢ºèªãƒ¬ãƒãƒ¼ãƒˆ"
  - "ãƒ•ã‚¯ãƒ­ã‚¦å†ãƒ¬ãƒ“ãƒ¥ãƒ¼çµæœï¼ˆPASSEDï¼‰"
