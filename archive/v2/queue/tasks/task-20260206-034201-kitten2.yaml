task_id: "task-20260206-034201-kitten2"
assigned_to: "kitten2"
timestamp: "2026-02-06T03:42:01"
priority: urgent
load_skills: []
description: |
  ## ğŸš¨ CDK ç’°å¢ƒå¤‰æ•° + IAM æ¨©é™è¿½åŠ ï¼ˆã‚¿ã‚¹ã‚¯3+4ï¼‰

  Lambda handler.py ãŒ AgentCore Runtime ã‚’å‘¼ã³å‡ºã™ãŸã‚ã«ã€
  CDK ã§ç’°å¢ƒå¤‰æ•°ã¨ IAM æ¨©é™ã‚’è¨­å®šã™ã‚‹ã«ã‚ƒã€œã€‚

  ## èƒŒæ™¯

  - å­çŒ«1ãŒ handler.py ã‚’ AgentCore Runtime API ã«æ›¸ãæ›ãˆã‚‹
  - ãã®ãŸã‚ã« RUNTIME_ARN ç’°å¢ƒå¤‰æ•°ã¨ IAM æ¨©é™ãŒå¿…è¦

  ## ä½œæ¥­ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒª

  `/home/edgesakura/neko-pm/output/izakaya-agent/`

  ## ã‚¿ã‚¹ã‚¯3: CDK ç’°å¢ƒå¤‰æ•°ä¿®æ­£

  **ãƒ•ã‚¡ã‚¤ãƒ«**: `infra/lib/izakaya-stack.ts`

  ### ä¿®æ­£å†…å®¹

  Lambda Function ã®ç’°å¢ƒå¤‰æ•°ã‚’ä¿®æ­£ã™ã‚‹ã«ã‚ƒï¼š

  ```typescript
  // Lambda Function ã® environment ã‚»ã‚¯ã‚·ãƒ§ãƒ³
  environment: {
    // å‰Šé™¤ï¼ˆã‚‚ã—å­˜åœ¨ã™ã‚Œã°ï¼‰
    // AGENT_ID: props?.agentId || "",
    // AGENT_ALIAS_ID: props?.agentAliasId || "",

    // è¿½åŠ 
    RUNTIME_ARN: "arn:aws:bedrock-agentcore:ap-northeast-1:921563379197:runtime/izakaya_agent-9JGtN3Enat",
    MEMORY_ID: props?.memoryId || "izakaya_agent_mem-ZOMh0R8tfz",
    ...
  }
  ```

  **é‡è¦**: AGENT_ID ã¨ AGENT_ALIAS_ID ã¯å‰Šé™¤ã€RUNTIME_ARN ã‚’è¿½åŠ ã«ã‚ƒã€‚

  ## ã‚¿ã‚¹ã‚¯4: Lambda IAM æ¨©é™è¿½åŠ 

  **ãƒ•ã‚¡ã‚¤ãƒ«**: `infra/lib/izakaya-stack.ts`

  ### ä¿®æ­£å†…å®¹

  Lambda Execution Role ã« `bedrock-agentcore:InvokeRuntime` æ¨©é™ã‚’è¿½åŠ ã™ã‚‹ã«ã‚ƒï¼š

  ```typescript
  // Lambda Execution Role ã®ãƒãƒªã‚·ãƒ¼ã‚¹ãƒ†ãƒ¼ãƒˆãƒ¡ãƒ³ãƒˆè¿½åŠ 
  lambdaRole.addToPolicy(new iam.PolicyStatement({
    effect: iam.Effect.ALLOW,
    actions: [
      "bedrock-agentcore:InvokeRuntime"
    ],
    resources: [
      "arn:aws:bedrock-agentcore:ap-northeast-1:921563379197:runtime/izakaya_agent-9JGtN3Enat"
    ]
  }));
  ```

  **ã¾ãŸã¯** ManagedPolicyStatement ã‚’ä½¿ã†å ´åˆï¼š

  ```typescript
  lambdaRole.addToPolicy(new iam.PolicyStatement({
    effect: iam.Effect.ALLOW,
    actions: ["bedrock-agentcore:InvokeRuntime"],
    resources: ["arn:aws:bedrock-agentcore:ap-northeast-1:921563379197:runtime/*"]
  }));
  ```

  ### æ—¢å­˜ã® Bedrock æ¨©é™ã«ã¤ã„ã¦

  ç¾åœ¨ã®ã‚³ãƒ¼ãƒ‰ã« `bedrock:InvokeAgent` ãªã©ã®æ¨©é™ãŒã‚ã‚Œã°ã€
  `bedrock-agentcore:InvokeRuntime` ã‚’è¿½åŠ ã§è¨˜è¿°ã™ã‚‹ã«ã‚ƒã€‚

  ## æˆåŠŸåˆ¤å®šåŸºæº–

  ä»¥ä¸‹ã‚’å…¨ã¦æº€ãŸã™å ´åˆã€ã‚¿ã‚¹ã‚¯å®Œäº†ã¨ã™ã‚‹ã«ã‚ƒï¼š

  - [ ] RUNTIME_ARN ç’°å¢ƒå¤‰æ•°ã‚’ Lambda ã«è¿½åŠ 
  - [ ] AGENT_ID, AGENT_ALIAS_ID ç’°å¢ƒå¤‰æ•°ã‚’å‰Šé™¤ï¼ˆã‚‚ã—å­˜åœ¨ã™ã‚Œã°ï¼‰
  - [ ] bedrock-agentcore:InvokeRuntime æ¨©é™ã‚’ Lambda Role ã«è¿½åŠ 
  - [ ] CDK ãƒ•ã‚¡ã‚¤ãƒ«ã«æ§‹æ–‡ã‚¨ãƒ©ãƒ¼ãŒãªã„

  ## ã‚¨ãƒ©ãƒ¼ãƒãƒ³ãƒ‰ãƒªãƒ³ã‚°

  ### ã‚¨ãƒ©ãƒ¼1: TypeScript æ§‹æ–‡ã‚¨ãƒ©ãƒ¼
  **ç—‡çŠ¶**: `npx tsc` ã§ã‚¨ãƒ©ãƒ¼
  **å¯¾å‡¦æ³•**: æ§‹æ–‡ã‚’ç¢ºèªã€å‹å®šç¾©ã‚’ä¿®æ­£

  ### ã‚¨ãƒ©ãƒ¼2: CDK ãƒ‡ãƒ—ãƒ­ã‚¤ã‚¨ãƒ©ãƒ¼
  **ç—‡çŠ¶**: `cdk deploy` å¤±æ•—
  **å¯¾å‡¦æ³•**: CloudFormation ã‚¨ãƒ©ãƒ¼ã‚’ç¢ºèªã€ãƒªã‚½ãƒ¼ã‚¹åã‚„ARNã‚’ç¢ºèª

  ## å‚è€ƒæƒ…å ±

  ### RUNTIME_ARN ã®å½¢å¼
  ```
  arn:aws:bedrock-agentcore:{region}:{account-id}:runtime/{runtime-id}
  ```

  **ä»Šå›ã®å€¤**:
  ```
  arn:aws:bedrock-agentcore:ap-northeast-1:921563379197:runtime/izakaya_agent-9JGtN3Enat
  ```

  ### IAM Action
  - `bedrock-agentcore:InvokeRuntime`: AgentCore Runtime å‘¼ã³å‡ºã—æ¨©é™

  ## æ³¨æ„äº‹é …

  - CDK ãƒ‡ãƒ—ãƒ­ã‚¤ã¯å­çŒ«1ãƒ»å­çŒ«2ã®ã‚¿ã‚¹ã‚¯å®Œäº†å¾Œã«å®Ÿè¡Œ
  - ãƒ‡ãƒ—ãƒ­ã‚¤æ™‚ã« Lambda Function ãŒå†ä½œæˆã•ã‚Œã‚‹å¯èƒ½æ€§ãŒã‚ã‚‹
  - Function URL ã¯å¤‰ã‚ã‚‰ãªã„ã¯ãšï¼ˆæ—¢å­˜ãƒªã‚½ãƒ¼ã‚¹ï¼‰

context:
  cdk_stack: "/home/edgesakura/neko-pm/output/izakaya-agent/infra/lib/izakaya-stack.ts"
  runtime_arn: "arn:aws:bedrock-agentcore:ap-northeast-1:921563379197:runtime/izakaya_agent-9JGtN3Enat"
  region: "ap-northeast-1"
  account_id: "921563379197"
expected_outputs:
  - "CDK ç’°å¢ƒå¤‰æ•°ä¿®æ­£å®Œäº†"
  - "IAM æ¨©é™è¿½åŠ å®Œäº†"
  - "queue/reports/report-task-20260206-034201-kitten2.yaml"
