task_id: "task-20260206-015929-kitten1"
assigned_to: "kitten1"
timestamp: "2026-02-06T01:59:29"
priority: high
load_skills: []
description: |
  ## Phase 4: ãƒ‡ãƒ—ãƒ­ã‚¤ãƒ»ãƒ†ã‚¹ãƒˆæº–å‚™

  AgentCoreãƒ‡ãƒ—ãƒ­ã‚¤ã®æº–å‚™ã¨Lambda Layerè¨­å®šã‚’è¡Œã†ã«ã‚ƒã€‚
  å®Ÿéš›ã®ãƒ‡ãƒ—ãƒ­ã‚¤ã¯ã”ä¸»äººãŒå®Ÿè¡Œã™ã‚‹ã«ã‚ƒã€‚

  ## èƒŒæ™¯ã¨ç›®çš„

  Phase 1-3 ã§ä»¥ä¸‹ã‚’å®Ÿè£…ã—ãŸã«ã‚ƒï¼š
  - Phase 1: CDKã‚¤ãƒ³ãƒ•ãƒ©æ§‹ç¯‰ï¼ˆSecrets Manager, IAM, Lambdaï¼‰
  - Phase 2: ã‚¨ãƒ¼ã‚¸ã‚§ãƒ³ãƒˆå®Ÿè£…ï¼ˆStrands Agents + AgentCore Runtimeï¼‰
  - Phase 2.5: Memoryæ©Ÿèƒ½è¿½åŠ ï¼ˆä¼šè©±ç¶™ç¶šãƒ»æ–‡è„ˆç¶­æŒï¼‰
  - Phase 3: LINE Boté€£æºï¼ˆLambda Webhookï¼‰

  Phase 4 ã§ã¯ã€å®Ÿéš›ã«ãƒ‡ãƒ—ãƒ­ã‚¤ã§ãã‚‹ã‚ˆã†ã«æº–å‚™ã™ã‚‹ã«ã‚ƒï¼š
  - Lambda Layer ã§Pythonãƒ‘ãƒƒã‚±ãƒ¼ã‚¸ã‚’è¿½åŠ 
  - ç’°å¢ƒå¤‰æ•°ã‚’è¿½åŠ ï¼ˆAGENT_ID, AGENT_ALIAS_IDï¼‰
  - README.md ã«ãƒ‡ãƒ—ãƒ­ã‚¤æ‰‹é †ã‚’è¿½åŠ 

  ## ä½œæ¥­å†…å®¹

  ### ã‚¹ãƒ†ãƒƒãƒ—1: CDKã‚¹ã‚¿ãƒƒã‚¯æ›´æ–°ï¼ˆLambda Layerå¯¾å¿œï¼‰

  **ãƒ•ã‚¡ã‚¤ãƒ«**: output/izakaya-agent/infra/lib/izakaya-stack.ts

  ä»¥ä¸‹ã‚’è¿½åŠ ã™ã‚‹ã«ã‚ƒï¼š

  1. **Lambda Layer ä½œæˆ**ï¼ˆline-bot-sdkç”¨ï¼‰
     ```typescript
     import * as lambda from 'aws-cdk-lib/aws-lambda';
     import * as path from 'path';

     // Lambda Layer for Python dependencies
     const pythonDepsLayer = new lambda.LayerVersion(this, 'PythonDepsLayer', {
       code: lambda.Code.fromAsset(path.join(__dirname, '../../lambda-layer')),
       compatibleRuntimes: [lambda.Runtime.PYTHON_3_11],
       description: 'Python dependencies (line-bot-sdk, boto3)',
     });
     ```

  2. **Lambda Function ã« Layer è¿½åŠ  + ç’°å¢ƒå¤‰æ•°è¿½åŠ **
     ```typescript
     const webhookFunction = new lambda.Function(this, 'LineWebhookFunction', {
       runtime: lambda.Runtime.PYTHON_3_11,
       handler: 'handler.lambda_handler',
       code: lambda.Code.fromAsset(path.join(__dirname, '../../lambda')),
       timeout: Duration.seconds(60),
       role: lambdaRole,
       layers: [pythonDepsLayer],  // â† Lambda Layer è¿½åŠ 
       environment: {
         AGENT_ID: process.env.AGENT_ID || 'PLACEHOLDER_AGENT_ID',
         AGENT_ALIAS_ID: process.env.AGENT_ALIAS_ID || 'PLACEHOLDER_AGENT_ALIAS_ID',
       },
       description: 'LINE Webhook to Bedrock AgentCore',
     });
     ```

  3. **Lambda Layer ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªæ§‹é€ ä½œæˆ**ï¼ˆæ³¨æ„äº‹é …ã¨ã—ã¦è¨˜è¼‰ï¼‰
     ```
     lambda-layer/
     â””â”€â”€ python/
         â””â”€â”€ lib/
             â””â”€â”€ python3.11/
                 â””â”€â”€ site-packages/
                     â””â”€â”€ (pip install ã—ãŸãƒ‘ãƒƒã‚±ãƒ¼ã‚¸)
     ```

     **é‡è¦**: ã”ä¸»äººãŒä»¥ä¸‹ã‚³ãƒãƒ³ãƒ‰ã§Lambda Layer ã‚’ä½œæˆã™ã‚‹å¿…è¦ãŒã‚ã‚‹ã«ã‚ƒï¼š
     ```bash
     cd output/izakaya-agent
     mkdir -p lambda-layer/python
     pip install -r lambda/requirements.txt -t lambda-layer/python
     ```

  ### ã‚¹ãƒ†ãƒƒãƒ—2: agent/requirements.txt ç¢ºèª

  **ãƒ•ã‚¡ã‚¤ãƒ«**: output/izakaya-agent/agent/requirements.txt

  ä»¥ä¸‹ãŒå«ã¾ã‚Œã¦ã„ã‚‹ã‹ç¢ºèªã«ã‚ƒï¼š
  - strands-agents>=0.1.0
  - boto3>=1.34.0
  - requests>=2.31.0
  - bedrock-agentcore-starter-toolkit>=0.1.0ï¼ˆPhase 2.5ã§è¿½åŠ æ¸ˆã¿ï¼‰

  **ä¸è¶³ã—ã¦ã„ã‚Œã°è¿½åŠ **ã™ã‚‹ã«ã‚ƒã€‚

  ### ã‚¹ãƒ†ãƒƒãƒ—3: README.md ã«Phase 4æ‰‹é †ã‚’è¿½åŠ 

  **ãƒ•ã‚¡ã‚¤ãƒ«**: output/izakaya-agent/README.md

  ä»¥ä¸‹ã®ã‚»ã‚¯ã‚·ãƒ§ãƒ³ã‚’è¿½åŠ ã™ã‚‹ã«ã‚ƒï¼š

  ```markdown
  ## Phase 4: ãƒ‡ãƒ—ãƒ­ã‚¤ãƒ»ãƒ†ã‚¹ãƒˆ ğŸš€

  ### å‰ææ¡ä»¶
  - AWS CLI è¨­å®šæ¸ˆã¿
  - Node.js 18+ ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«æ¸ˆã¿
  - Python 3.11+ ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«æ¸ˆã¿

  ### æ‰‹é †

  #### 1. Lambda Layer ä½œæˆ
  ```bash
  cd output/izakaya-agent
  mkdir -p lambda-layer/python
  pip install -r lambda/requirements.txt -t lambda-layer/python
  ```

  #### 2. AgentCore CLI ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«
  ```bash
  pip install bedrock-agentcore-starter-toolkit
  ```

  #### 3. Memory ãƒªã‚½ãƒ¼ã‚¹ä½œæˆ
  ```bash
  cd agent
  agentcore memory create IzakayaAgentMemory \
    --strategies '[{"semanticMemoryStrategy": {"name": "UserPreferences"}}]' \
    --region ap-northeast-1 \
    --wait
  ```

  #### 4. ã‚¨ãƒ¼ã‚¸ã‚§ãƒ³ãƒˆè¨­å®š
  ```bash
  agentcore configure \
    --entrypoint main.py \
    --name izakaya-agent \
    --runtime PYTHON_3_11 \
    --region ap-northeast-1 \
    --non-interactive
  ```

  #### 5. ã‚¨ãƒ¼ã‚¸ã‚§ãƒ³ãƒˆãƒ‡ãƒ—ãƒ­ã‚¤
  ```bash
  agentcore launch
  ```

  #### 6. ã‚¨ãƒ¼ã‚¸ã‚§ãƒ³ãƒˆIDå–å¾—
  ```bash
  agentcore status
  # AGENT_ID ã¨ AGENT_ALIAS_ID ã‚’ãƒ¡ãƒ¢
  ```

  #### 7. CDKã‚¹ã‚¿ãƒƒã‚¯ãƒ‡ãƒ—ãƒ­ã‚¤
  ```bash
  cd ../infra
  export AGENT_ID="<å–å¾—ã—ãŸAGENT_ID>"
  export AGENT_ALIAS_ID="<å–å¾—ã—ãŸAGENT_ALIAS_ID>"
  npm install
  cdk deploy
  ```

  #### 8. Lambda Function URL å–å¾—
  CDKãƒ‡ãƒ—ãƒ­ã‚¤å¾Œã€Outputs ã‹ã‚‰ Function URL ã‚’ãƒ¡ãƒ¢ï¼š
  ```
  IzakayaStack.LineWebhookFunctionUrl = https://xxxxx.lambda-url.ap-northeast-1.on.aws/
  ```

  #### 9. LINE Developers ã§ Webhook URL è¨­å®š
  1. LINE Developers Console ã«ãƒ­ã‚°ã‚¤ãƒ³
  2. ãƒãƒ£ãƒãƒ«ã‚’é¸æŠ
  3. Messaging API è¨­å®š > Webhook URL ã« Lambda Function URL ã‚’è¨­å®š
  4. ã€ŒWebhookã®åˆ©ç”¨ã€ã‚’ONã«ã™ã‚‹
  5. ã€Œæ¤œè¨¼ã€ã‚’ã‚¯ãƒªãƒƒã‚¯ã—ã¦ç–é€šç¢ºèª

  #### 10. å‹•ä½œãƒ†ã‚¹ãƒˆ
  1. LINEå…¬å¼ã‚¢ã‚«ã‚¦ãƒ³ãƒˆã‚’å‹ã ã¡è¿½åŠ 
  2. ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’é€ä¿¡
  3. CloudWatch Logs ã§å‹•ä½œç¢ºèª
     ```bash
     aws logs tail /aws/lambda/IzakayaStack-LineWebhookFunction --follow
     ```

  ### ãƒˆãƒ©ãƒ–ãƒ«ã‚·ãƒ¥ãƒ¼ãƒ†ã‚£ãƒ³ã‚°

  #### Lambda ã‚¿ã‚¤ãƒ ã‚¢ã‚¦ãƒˆ
  - CloudWatch Logs ã§å®Ÿè¡Œæ™‚é–“ã‚’ç¢ºèª
  - AgentCore ã®å¿œç­”ãŒé…ã„å ´åˆã¯ timeout ã‚’å»¶é•·

  #### LINEç½²åæ¤œè¨¼ã‚¨ãƒ©ãƒ¼
  - Secrets Manager ã«æ­£ã—ã„ãƒãƒ£ãƒãƒ«ã‚·ãƒ¼ã‚¯ãƒ¬ãƒƒãƒˆãŒç™»éŒ²ã•ã‚Œã¦ã„ã‚‹ã‹ç¢ºèª
  - `X-Line-Signature` ãƒ˜ãƒƒãƒ€ãƒ¼ãŒæ­£ã—ãæ¸¡ã•ã‚Œã¦ã„ã‚‹ã‹ç¢ºèª

  #### AgentCore Runtime ã‚¨ãƒ©ãƒ¼
  - AGENT_ID, AGENT_ALIAS_ID ãŒæ­£ã—ãè¨­å®šã•ã‚Œã¦ã„ã‚‹ã‹ç¢ºèª
  - AgentCore ã®ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹ã‚’ç¢ºèª: `agentcore status`
  - Memory ãƒªã‚½ãƒ¼ã‚¹ãŒä½œæˆã•ã‚Œã¦ã„ã‚‹ã‹ç¢ºèª

  #### Memoryæ©Ÿèƒ½ãŒå‹•ä½œã—ãªã„
  - Memory ãƒªã‚½ãƒ¼ã‚¹ãŒä½œæˆã•ã‚Œã¦ã„ã‚‹ã‹ç¢ºèª
  - session_idï¼ˆLINE user_idï¼‰ãŒæ­£ã—ãæ¸¡ã•ã‚Œã¦ã„ã‚‹ã‹ç¢ºèª
  - CloudWatch Logs ã§Memoryé–¢é€£ã‚¨ãƒ©ãƒ¼ã‚’ç¢ºèª
  ```

  ## æ³¨æ„äº‹é …

  - Lambda Layer ã¯ **ã”ä¸»äººãŒæ‰‹å‹•ã§ä½œæˆ**ã™ã‚‹å¿…è¦ãŒã‚ã‚‹ã«ã‚ƒ
  - AGENT_ID, AGENT_ALIAS_ID ã¯ **AgentCoreãƒ‡ãƒ—ãƒ­ã‚¤å¾Œã«å–å¾—**ã™ã‚‹ã«ã‚ƒ
  - CDKã‚¹ã‚¿ãƒƒã‚¯ãƒ‡ãƒ—ãƒ­ã‚¤æ™‚ã«ç’°å¢ƒå¤‰æ•°ã¨ã—ã¦æ¸¡ã™ã«ã‚ƒ
  - å‹ãƒ’ãƒ³ãƒˆï¼ˆtypingï¼‰ã‚’å…¨é–¢æ•°ã«ä»˜ä¸ã«ã‚ƒ
  - ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆæ–‡å­—åˆ—ã‚’å…¨é–¢æ•°ã«è¨˜è¼‰ã«ã‚ƒ

  ## Phase 4 ã®æˆæœç‰©

  - âœ… izakaya-stack.ts æ›´æ–°ï¼ˆLambda Layer, ç’°å¢ƒå¤‰æ•°ï¼‰
  - âœ… agent/requirements.txt ç¢ºèªï¼ˆbedrock-agentcoreè¿½åŠ ç¢ºèªï¼‰
  - âœ… README.md ã«Phase 4æ‰‹é †è¿½åŠ 

context:
  output_dir: "output/izakaya-agent"
  region: "ap-northeast-1"
  references:
    - "Phase 1ã§å®Ÿè£…ã—ãŸCDKã‚¹ã‚¿ãƒƒã‚¯"
    - "Phase 2ã§å®Ÿè£…ã—ãŸã‚¨ãƒ¼ã‚¸ã‚§ãƒ³ãƒˆ"
    - "Phase 2.5ã§å®Ÿè£…ã—ãŸMemoryæ©Ÿèƒ½"
    - "Phase 3ã§å®Ÿè£…ã—ãŸLambda Webhook"
expected_outputs:
  - "output/izakaya-agent/infra/lib/izakaya-stack.tsï¼ˆLambda Layer, ç’°å¢ƒå¤‰æ•°è¿½åŠ ï¼‰"
  - "output/izakaya-agent/agent/requirements.txtï¼ˆç¢ºèªãƒ»æ›´æ–°ï¼‰"
  - "output/izakaya-agent/README.mdï¼ˆPhase 4æ‰‹é †è¿½åŠ ï¼‰"
  - "queue/reports/report-task-20260206-015929-kitten1.yaml"
